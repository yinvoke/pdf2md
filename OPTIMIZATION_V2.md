# ä¼˜åŒ– V2.0 - å¹¶å‘å¤„ç†ä¸æ™ºèƒ½ç¼“å­˜

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜1ï¼šè¯·æ±‚é˜»å¡
**ç°è±¡**ï¼šè½¬æ¢PDFæ—¶ï¼Œå…¶ä»–è¯·æ±‚ï¼ˆå¦‚healthæ£€æŸ¥ï¼‰è¢«é˜»å¡ï¼Œéœ€ç­‰å¾…è½¬æ¢å®Œæˆæ‰èƒ½å“åº”  
**åŸå› **ï¼šè½¬æ¢åœ¨ä¸»äº‹ä»¶å¾ªç¯åŒæ­¥æ‰§è¡Œï¼Œé˜»å¡äº†æ•´ä¸ªåº”ç”¨  
**å½±å“**ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œæ— æ³•å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚

### é—®é¢˜2ï¼šé‡å¤è½¬æ¢
**ç°è±¡**ï¼šç›¸åŒæ–‡ä»¶é‡å¤ä¸Šä¼ ä¼šé‡æ–°è½¬æ¢ï¼Œæµªè´¹GPUèµ„æº  
**åŸå› **ï¼šç¼“å­˜åŸºäºéšæœºUUIDï¼Œæ— æ³•è¯†åˆ«æ–‡ä»¶å†…å®¹æ˜¯å¦ç›¸åŒ  
**å½±å“**ï¼šèµ„æºæµªè´¹ï¼Œå“åº”æ—¶é—´æ…¢

---

## âœ… å®ç°çš„ä¼˜åŒ–

### 1. å¼‚æ­¥éé˜»å¡å¤„ç†

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨`ThreadPoolExecutor`åˆ›å»ºä¸“ç”¨çº¿ç¨‹æ± 
- é€šè¿‡`asyncio.run_in_executor`å°†è½¬æ¢ä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± 
- ä¸»äº‹ä»¶å¾ªç¯ä¿æŒå“åº”ï¼Œå¯å¤„ç†å…¶ä»–è¯·æ±‚

**ä»£ç å®ç°**ï¼š
```python
from concurrent.futures import ThreadPoolExecutor
from functools import partial

# åˆ›å»ºçº¿ç¨‹æ± ï¼ˆæœ€å¤š2ä¸ªå¹¶å‘è½¬æ¢ï¼‰
_executor = ThreadPoolExecutor(max_workers=2, thread_name_prefix="pdf-convert")

# å¼‚æ­¥è½¬æ¢
loop = asyncio.get_event_loop()
convert_func = partial(convert_pdf_to_markdown, pdf_path=tmp_path, return_summary=True)
markdown, summary = await loop.run_in_executor(_executor, convert_func)
```

**æ•ˆæœéªŒè¯**ï¼š
```
è½¬æ¢è¿›è¡Œä¸­...
  healthæ¥å£å“åº”æ—¶é—´ï¼š167ms âœ“ï¼ˆæœªè¢«é˜»å¡ï¼‰
  
å¯¹æ¯”ï¼šä¼˜åŒ–å‰éœ€ç­‰å¾…å®Œæ•´è½¬æ¢æ—¶é—´ï¼ˆ60-90ç§’ï¼‰
```

---

### 2. å†…å®¹å“ˆå¸Œç¼“å­˜

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨SHA256è®¡ç®—æ–‡ä»¶å†…å®¹å“ˆå¸Œ
- åŒå±‚ç¼“å­˜ï¼šå†…å­˜ç¼“å­˜ï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰ + æ–‡ä»¶ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
- åŒºåˆ†æ™®é€šè½¬æ¢å’Œè´¢æŠ¥è½¬æ¢ï¼ˆä½¿ç”¨ä¸åŒå‰ç¼€ï¼‰

**ä»£ç å®ç°**ï¼š
```python
import hashlib

# è®¡ç®—å†…å®¹å“ˆå¸Œ
def _compute_content_hash(content: bytes) -> str:
    return hashlib.sha256(content).hexdigest()

# å†…å­˜ç¼“å­˜ç»“æ„
_content_cache: Dict[str, tuple[str, float]] = {}
# æ ¼å¼ï¼š{content_hash: (file_id, timestamp)}

# ç¼“å­˜æ£€æŸ¥
cached_file_id = _check_cache(content_hash)
if cached_file_id:
    # ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
    return {"id": cached_file_id, "cached": True}
```

**ç¼“å­˜ç­–ç•¥**ï¼š
- **æ™®é€šè½¬æ¢**ï¼š`content_hash = SHA256(file_content)`
- **è´¢æŠ¥è½¬æ¢**ï¼š`content_hash = "report:" + SHA256(file_content)`
- **TTL**ï¼š1å°æ—¶åè‡ªåŠ¨è¿‡æœŸ

**æ•ˆæœéªŒè¯**ï¼š
```
é¦–æ¬¡è½¬æ¢ï¼š9ç§’ï¼Œcached=false
äºŒæ¬¡è½¬æ¢ï¼š24msï¼Œcached=true âœ“ï¼ˆåŠ é€Ÿ375å€ï¼‰
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡è½¬æ¢ï¼ˆ10é¡µï¼‰ | 9ç§’ | 9ç§’ | - |
| é‡å¤è½¬æ¢ï¼ˆ10é¡µï¼‰ | 9ç§’ | **24ms** | **375å€** |
| è½¬æ¢æ—¶healthå“åº” | **é˜»å¡60-90s** | **<200ms** | **300å€+** |
| å¹¶å‘èƒ½åŠ› | å•çº¿ç¨‹é˜»å¡ | **2å¹¶å‘** | 2å€åå |

---

## ğŸ”§ é…ç½®å‚æ•°

### çº¿ç¨‹æ± é…ç½®
```python
max_workers=2  # æœ€å¤§å¹¶å‘è½¬æ¢æ•°
thread_name_prefix="pdf-convert"  # çº¿ç¨‹åç§°å‰ç¼€ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
```

**ä¸ºä»€ä¹ˆæ˜¯2ï¼Ÿ**
- GPUé€šå¸¸åŒæ—¶å¤„ç†1ä¸ªä»»åŠ¡æœ€é«˜æ•ˆ
- 2ä¸ªçº¿ç¨‹ï¼š1ä¸ªæ‰§è¡Œè½¬æ¢ï¼Œ1ä¸ªæ’é˜Ÿç­‰å¾…
- å†å¤šä¼šå¢åŠ GPUä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

### ç¼“å­˜é…ç½®
```python
CACHE_TTL_SECONDS = 60 * 60  # 1å°æ—¶
CACHE_DIR = Path("cache/markdown")
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç¼“å­˜å‘½ä¸­
```bash
# ç¬¬ä¸€æ¬¡ä¸Šä¼ 
curl -X POST http://localhost:12138/convert -F "file=@report.pdf"
# è¿”å›ï¼š{"cached": false, "id": "abc123..."}
# è€—æ—¶ï¼š9ç§’

# ç¬¬äºŒæ¬¡ä¸Šä¼ åŒä¸€æ–‡ä»¶
curl -X POST http://localhost:12138/convert -F "file=@report.pdf"
# è¿”å›ï¼š{"cached": true, "id": "abc123..."} â† ç›¸åŒID
# è€—æ—¶ï¼š24ms â† å¿«é€Ÿè¿”å›
```

### ç¤ºä¾‹2ï¼šå¹¶å‘è¯·æ±‚
```bash
# ç»ˆç«¯1ï¼šå¼€å§‹è½¬æ¢å¤§æ–‡ä»¶
curl -X POST http://localhost:12138/convert_report -F "file=@large.pdf"

# ç»ˆç«¯2ï¼šåŒæ—¶æ£€æŸ¥å¥åº·çŠ¶æ€ï¼ˆä¸ä¼šè¢«é˜»å¡ï¼‰
curl http://localhost:12138/health
# ç«‹å³è¿”å›ï¼š{"status": "ok"} âœ“
```

### ç¤ºä¾‹3ï¼šåŒºåˆ†è½¬æ¢æ¨¡å¼
```bash
# æ™®é€šè½¬æ¢
curl -X POST http://localhost:12138/convert -F "file=@report.pdf"
# ç¼“å­˜key: 3a5f8bc...

# è´¢æŠ¥è½¬æ¢ï¼ˆç›¸åŒæ–‡ä»¶ï¼‰
curl -X POST http://localhost:12138/convert_report -F "file=@report.pdf"
# ç¼“å­˜key: report:3a5f8bc...  â† ä¸åŒkeyï¼Œä¼šé‡æ–°è½¬æ¢
```

---

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶éš”ç¦»
- ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼š`tempfile.mktemp(suffix=".pdf")`
- å¤„ç†å®Œæˆåç«‹å³åˆ é™¤ï¼š`finally: tmp_path.unlink(missing_ok=True)`

### 2. ç¼“å­˜æ¸…ç†
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆæ¯æ¬¡è¯·æ±‚è§¦å‘ï¼‰
- å†…å­˜ç¼“å­˜è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ç¼“å­˜çŠ¶æ€
- é˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½

### 3. å¹¶å‘é™åˆ¶
- çº¿ç¨‹æ± æœ€å¤§2ä¸ªworker
- é˜²æ­¢GPUè¿‡è½½
- é˜²æ­¢å†…å­˜æº¢å‡º

---

## ğŸ“ APIå˜æ›´

### å“åº”æ ¼å¼æ–°å¢å­—æ®µ

```json
{
  "id": "abc123...",
  "url": "http://localhost:12138/files/abc123...",
  "name": "report.md",
  "cached": true  â† æ–°å¢ï¼šæ˜¯å¦æ¥è‡ªç¼“å­˜
}
```

**å‘åå…¼å®¹**ï¼š
- æ—§å®¢æˆ·ç«¯å¯å¿½ç•¥`cached`å­—æ®µ
- å…¶ä»–å­—æ®µæ ¼å¼ä¸å˜

---

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### æ—¥å¿—ç¤ºä¾‹

```
# ç¼“å­˜æœªå‘½ä¸­ï¼ˆé¦–æ¬¡ï¼‰
convert done | filename=report.md size=1234.5KB hash=3a5f8bc1... duration=9.123s

# ç¼“å­˜å‘½ä¸­ï¼ˆåç»­ï¼‰
convert cached | filename=report.md size=1234.5KB hash=3a5f8bc1... duration=0.024s
```

### æ—¥å¿—å­—æ®µè¯´æ˜
- `hash=...`ï¼šæ–‡ä»¶å†…å®¹å“ˆå¸Œï¼ˆå‰16å­—ç¬¦ï¼‰
- `cached`æ—¥å¿—ï¼šè¡¨ç¤ºç¼“å­˜å‘½ä¸­
- `duration`ï¼šåŒ…å«ç¼“å­˜æŸ¥æ‰¾æ—¶é—´

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶åä¸å½±å“ç¼“å­˜
```bash
# è¿™ä¸¤ä¸ªè¯·æ±‚ä¼šå‘½ä¸­åŒä¸€ç¼“å­˜ï¼ˆå†…å®¹ç›¸åŒï¼‰
ä¸Šä¼  report.pdf
ä¸Šä¼  report_copy.pdf  â† ç¼“å­˜å‘½ä¸­
```

### 2. ç¼“å­˜ç©¿é€
```bash
# ç›¸åŒæ–‡ä»¶åœ¨1å°æ—¶å†…é‡å¤ä¸Šä¼ 1000æ¬¡
# åªæœ‰ç¬¬ä¸€æ¬¡ä¼šçœŸæ­£è½¬æ¢ï¼Œåç»­999æ¬¡éƒ½æ˜¯ç¼“å­˜å‘½ä¸­
```

### 3. å†…å­˜å ç”¨
```
æ¯ä¸ªç¼“å­˜æ¡ç›®ï¼šçº¦100å­—èŠ‚ï¼ˆhash + file_id + timestampï¼‰
1000ä¸ªç¼“å­˜æ–‡ä»¶ï¼šçº¦100KBå†…å­˜

å¯å¿½ç•¥ä¸è®¡
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### Dockerå·æŒ‚è½½
```bash
docker run -d \
  --name pdf2md-server \
  --gpus all \
  -p 12138:12138 \
  -v $(pwd)/cache:/app/cache  # â† æŒä¹…åŒ–ç¼“å­˜
  pdf2md:latest
```

**å¥½å¤„**ï¼š
- å®¹å™¨é‡å¯ç¼“å­˜ä¿ç•™
- å¤šå®¹å™¨å…±äº«ç¼“å­˜ï¼ˆéœ€åŠ é”ï¼Œå½“å‰ç‰ˆæœ¬ä¸æ”¯æŒï¼‰

### ç”Ÿäº§ç¯å¢ƒ
```bash
# å®šæœŸæ¸…ç†ç£ç›˜ç¼“å­˜ï¼ˆcrontabï¼‰
0 */6 * * * find /app/cache -name "*.md" -mtime +1 -delete

# ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
grep "cached" /app/logs/app.log | wc -l
```

---

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸ
- [ ] æ·»åŠ ç¼“å­˜ç»Ÿè®¡APIï¼ˆå‘½ä¸­ç‡ã€ç¼“å­˜å¤§å°ï¼‰
- [ ] æ”¯æŒæ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
- [ ] ç¼“å­˜é¢„çƒ­åŠŸèƒ½

### é•¿æœŸ
- [ ] åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
- [ ] ç¼“å­˜åˆ†å±‚ï¼ˆL1å†…å­˜ + L2ç£ç›˜ + L3å¯¹è±¡å­˜å‚¨ï¼‰
- [ ] æ™ºèƒ½ç¼“å­˜æ·˜æ±°ï¼ˆLRU/LFUï¼‰

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›
1. âœ… **å¼‚æ­¥éé˜»å¡** - ä¸»çº¿ç¨‹ä¸é˜»å¡ï¼Œå¹¶å‘èƒ½åŠ›æå‡
2. âœ… **å†…å®¹å“ˆå¸Œç¼“å­˜** - ç›¸åŒæ–‡ä»¶375å€åŠ é€Ÿ
3. âœ… **åŒå±‚ç¼“å­˜** - å†…å­˜å¿«é€ŸæŸ¥æ‰¾ + ç£ç›˜æŒä¹…åŒ–
4. âœ… **è‡ªåŠ¨æ¸…ç†** - é˜²æ­¢ç¼“å­˜æ— é™å¢é•¿

### æ€§èƒ½æå‡
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šé¢„è®¡70%+ï¼ˆé‡å¤ä¸Šä¼ åœºæ™¯ï¼‰
- **å“åº”æ—¶é—´**ï¼šä»9ç§’é™è‡³24msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- **å¹¶å‘èƒ½åŠ›**ï¼šä»å•çº¿ç¨‹é˜»å¡æå‡è‡³2å¹¶å‘
- **ç”¨æˆ·ä½“éªŒ**ï¼šè½¬æ¢æ—¶å…¶ä»–æ¥å£ä¿æŒå“åº”

### å…¼å®¹æ€§
- âœ… APIå‘åå…¼å®¹
- âœ… ç°æœ‰å®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹
- âœ… Dockeré•œåƒæ­£å¸¸å‡çº§

---

**ç‰ˆæœ¬**ï¼š0.2.0  
**ä¼˜åŒ–æ—¶é—´**ï¼š2026-02-27  
**Dockeré•œåƒ**ï¼špdf2md:latest  
**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²å¹¶éªŒè¯
